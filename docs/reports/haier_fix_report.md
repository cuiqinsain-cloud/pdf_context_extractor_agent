# æµ·å°”æ™ºå®¶æ•°æ®æå–é—®é¢˜ä¿®å¤æŠ¥å‘Š

**æ—¥æœŸ**: 2026-02-05
**ä¼˜å…ˆçº§**: P1
**çŠ¶æ€**: âœ… å·²è§£å†³

---

## ä¸€ã€é—®é¢˜æè¿°

### 1.1 ç°è±¡

æµ·å°”æ™ºå®¶çš„éƒ¨åˆ†æµåŠ¨èµ„äº§æ•°æ®æ— æ³•æå–ï¼Œæ˜¾ç¤ºä¸º Noneï¼š
- è´§å¸èµ„é‡‘: æœ¬æœŸ=None, ä¸ŠæœŸ=None
- åº”æ”¶è´¦æ¬¾: æœ¬æœŸ=None, ä¸ŠæœŸ=None
- ä½†å›ºå®šèµ„äº§ç­‰æ•°æ®æ­£å¸¸: æœ¬æœŸ=37,518,645,325.08, ä¸ŠæœŸ=33,425,684,876.90

### 1.2 å½±å“

- æ•°æ®æå–å‡†ç¡®ç‡: ~70%
- å¹³å‡å‡†ç¡®ç‡: 92.5% â†’ ç›®æ ‡ 95%+

---

## äºŒã€æ ¹æœ¬åŸå› åˆ†æ

### 2.1 è¡¨æ ¼ç»“æ„

æµ·å°”æ™ºå®¶çš„PDFè¡¨æ ¼å­˜åœ¨**åˆå¹¶å•å…ƒæ ¼å¯¼è‡´çš„åˆ—åç§»**é—®é¢˜ï¼š

**è¡¨å¤´è¡Œï¼ˆç¬¬0è¡Œï¼‰- 12åˆ—æ ¼å¼**ï¼š
```
åˆ—0: ''
åˆ—1: 'é¡¹ç›®'
åˆ—4: 'é™„æ³¨'
åˆ—7: '2024å¹´12æœˆ31æ—¥'
åˆ—10: '2023å¹´12æœˆ31æ—¥'
```

**æ•°æ®è¡Œï¼ˆç¬¬2è¡Œï¼‰- 12åˆ—æ ¼å¼**ï¼š
```
åˆ—0: 'è´§å¸èµ„é‡‘'
åˆ—3: 'ä¸ƒã€1'
åˆ—6: '55,583,842,589.70'
åˆ—9: '57,255,962,206.24'
```

**å…³é”®å‘ç°**ï¼š
- è¡¨å¤´è¡Œçš„åˆ—ç´¢å¼•ï¼š1, 4, 7, 10
- æ•°æ®è¡Œçš„åˆ—ç´¢å¼•ï¼š0, 3, 6, 9
- **åç§»é‡ï¼š-1åˆ—**

### 2.2 ä»£ç é—®é¢˜

#### é—®é¢˜1ï¼šColumnAnalyzer è¯†åˆ«è¡¨å¤´

`ColumnAnalyzer` æ­£ç¡®è¯†åˆ«äº†è¡¨å¤´ç»“æ„ï¼š
```python
{
    'item_name_col': 1,
    'note_col': 4,
    'current_period_col': 7,
    'previous_period_col': 10
}
```

#### é—®é¢˜2ï¼šæ•°æ®æå–å¤±è´¥

`balance_sheet.py` çš„ `_extract_values_from_row` æ–¹æ³•ï¼š
- ä½¿ç”¨è¡¨å¤´çš„åˆ—ç´¢å¼•ï¼ˆ1, 4, 7, 10ï¼‰
- ç›´æ¥è®¿é—® `row[7]` å’Œ `row[10]`
- ä½†å®é™…æ•°æ®åœ¨ `row[6]` å’Œ `row[9]`
- ç»“æœï¼šæå–åˆ° None

#### é—®é¢˜3ï¼šè·¨é¡µæ ¼å¼å˜åŒ–

åç»­é¡µé¢ï¼ˆç¬¬34è¡Œï¼‰åˆ‡æ¢åˆ°4åˆ—æ ¼å¼ï¼š
```
åˆ—0: 'å›ºå®šèµ„äº§'
åˆ—1: 'ä¸ƒã€17'
åˆ—2: '37,518,645,325.08'
åˆ—3: '33,425,684,876.90'
```

è¿™ç§æ ¼å¼æ²¡æœ‰åˆ—åç§»é—®é¢˜ï¼Œæ‰€ä»¥å›ºå®šèµ„äº§æ•°æ®æ­£å¸¸ã€‚

---

## ä¸‰ã€è§£å†³æ–¹æ¡ˆ

### 3.1 æ–¹æ¡ˆè®¾è®¡

åœ¨ `ColumnAnalyzer` ä¸­æ·»åŠ **æ™ºèƒ½åˆ—åç§»æ£€æµ‹æœºåˆ¶**ï¼š

1. **é¦–æ¬¡å°è¯•**ï¼šä½¿ç”¨è¡¨å¤´è¯†åˆ«çš„åˆ—ç´¢å¼•
2. **åç§»æ£€æµ‹**ï¼šå¦‚æœå€¼ä¸º None æˆ–ç©ºï¼Œå°è¯•ç›¸é‚»åˆ—
3. **ç±»å‹éªŒè¯**ï¼šéªŒè¯æ‰¾åˆ°çš„å€¼æ˜¯å¦ç¬¦åˆé¢„æœŸç±»å‹
4. **æœç´¢èŒƒå›´**ï¼šåç§»é‡ [0, -1, +1, -2, +2, -3, +3]

### 3.2 ä»£ç å®ç°

#### ä¿®æ”¹1ï¼šcolumn_analyzer.py

æ·»åŠ  `_extract_with_offset` æ–¹æ³•ï¼š

```python
def _extract_with_offset(self, row: List[str], base_idx: int,
                        value_type: Optional[str] = None) -> Optional[str]:
    """
    ä»è¡Œä¸­æå–å€¼ï¼Œæ”¯æŒåˆ—åç§»æ£€æµ‹
    """
    # å®šä¹‰æœç´¢åç§»é‡
    offsets = [0, -1, 1, -2, 2, -3, 3]

    for offset in offsets:
        idx = base_idx + offset
        if idx < 0 or idx >= len(row):
            continue

        cell = row[idx]
        if cell is None or not str(cell).strip():
            continue

        cell_text = str(cell).strip()

        # ç±»å‹éªŒè¯
        if value_type == 'numeric':
            if self._is_numeric_format(cell_text):
                if offset != 0:
                    logger.debug(f"åˆ—åç§»æ£€æµ‹: åœ¨åˆ—{idx}æ‰¾åˆ°æ•°å€¼(åç§»{offset})")
                return cell
        elif value_type == 'note':
            if self._is_note_format(cell_text):
                if offset != 0:
                    logger.debug(f"åˆ—åç§»æ£€æµ‹: åœ¨åˆ—{idx}æ‰¾åˆ°é™„æ³¨(åç§»{offset})")
                return cell
        elif value_type is None:
            if offset != 0:
                logger.debug(f"åˆ—åç§»æ£€æµ‹: åœ¨åˆ—{idx}æ‰¾åˆ°å€¼(åç§»{offset})")
            return cell

    return None
```

#### ä¿®æ”¹2ï¼šbalance_sheet.py

ä½¿ç”¨ ColumnAnalyzer çš„æ™ºèƒ½æå–æ–¹æ³•ï¼š

```python
# æ„å»ºåˆ—æ˜ å°„
column_map = {}
if header_info.get('item_name_col') is not None:
    column_map[ColumnType.ITEM_NAME] = header_info['item_name_col']
if header_info.get('current_period_col') is not None:
    column_map[ColumnType.CURRENT_PERIOD] = header_info['current_period_col']
if header_info.get('previous_period_col') is not None:
    column_map[ColumnType.PREVIOUS_PERIOD] = header_info['previous_period_col']
if header_info.get('note_col') is not None:
    column_map[ColumnType.NOTE] = header_info['note_col']

# ä½¿ç”¨ ColumnAnalyzer çš„æ™ºèƒ½æå–æ–¹æ³•ï¼ˆæ”¯æŒåˆ—åç§»æ£€æµ‹ï¼‰
extracted_values = self.column_analyzer.extract_values_from_row(row, column_map)
```

---

## å››ã€æµ‹è¯•éªŒè¯

### 4.1 å•å…ƒæµ‹è¯•

```bash
PYTHONPATH=. python3 tests/test_column_analyzer.py
```

**ç»“æœ**: âœ… 7/7 æµ‹è¯•é€šè¿‡

### 4.2 é›†æˆæµ‹è¯•

```bash
PYTHONPATH=. python3 tests/test_integration.py
```

**ç»“æœ**: âœ… 3/3 æµ‹è¯•é€šè¿‡

### 4.3 çœŸå®PDFæµ‹è¯•

```bash
python3 tests/test_real_pdf.py
```

**æµ·å°”æ™ºå®¶æµ‹è¯•ç»“æœ**ï¼š

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| è´§å¸èµ„é‡‘ | None | 55,583,842,589.70 âœ“ |
| åº”æ”¶è´¦æ¬¾ | None | 26,473,001,745.01 âœ“ |
| å›ºå®šèµ„äº§ | 37,518,645,325.08 âœ“ | 37,518,645,325.08 âœ“ |
| å¹³è¡¡æ€§æ£€æŸ¥ | é€šè¿‡ | é€šè¿‡ âœ“ |
| å®Œæ•´æ€§è¯„åˆ† | ~70% | 100% âœ“ |

**æ‰€æœ‰å…¬å¸æµ‹è¯•ç»“æœ**ï¼š

| å…¬å¸ | æµ‹è¯•ç»“æœ | å‡†ç¡®ç‡ |
|------|---------|--------|
| ç¦è€€ç»ç’ƒ | âœ“ é€šè¿‡ | 100% |
| æµ·å°”æ™ºå®¶ | âœ“ é€šè¿‡ | 100% âœ“ (ä¿®å¤) |
| æµ·å¤©å‘³ä¸š | âœ“ é€šè¿‡ | 100% |
| é‡‘å±±åŠå…¬ | âœ“ é€šè¿‡ | 100% |

**æ€»è®¡**: 4/4 é€šè¿‡ (100%)

---

## äº”ã€æŠ€æœ¯äº®ç‚¹

### 5.1 æ™ºèƒ½åˆ—åç§»æ£€æµ‹

- **è‡ªåŠ¨é€‚åº”**ï¼šæ— éœ€æ‰‹åŠ¨é…ç½®åç§»é‡
- **ç±»å‹éªŒè¯**ï¼šç¡®ä¿æå–çš„å€¼ç¬¦åˆé¢„æœŸæ ¼å¼
- **å‘åå…¼å®¹**ï¼šä¸å½±å“æ­£å¸¸æ ¼å¼çš„è¡¨æ ¼
- **æ€§èƒ½ä¼˜åŒ–**ï¼šä¼˜å…ˆå°è¯•åŸä½ç½®ï¼Œå‡å°‘æœç´¢å¼€é”€

### 5.2 å¥å£®æ€§æå‡

- **å¤„ç†åˆå¹¶å•å…ƒæ ¼**ï¼šPDFè¡¨æ ¼å¸¸è§é—®é¢˜
- **æ”¯æŒå¤šç§æ ¼å¼**ï¼š12åˆ—ã€4åˆ—ã€3åˆ—ç­‰
- **è·¨é¡µæ ¼å¼å˜åŒ–**ï¼šè‡ªåŠ¨é€‚åº”åˆ—æ•°å˜åŒ–

### 5.3 å¯ç»´æŠ¤æ€§

- **æ¨¡å—åŒ–è®¾è®¡**ï¼šåç§»æ£€æµ‹é€»è¾‘ç‹¬ç«‹å°è£…
- **æ¸…æ™°çš„æ—¥å¿—**ï¼šä¾¿äºè°ƒè¯•å’Œé—®é¢˜å®šä½
- **å®Œæ•´çš„æµ‹è¯•**ï¼šå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€çœŸå®PDFæµ‹è¯•

---

## å…­ã€æ€§èƒ½å½±å“

### 6.1 æ—¶é—´å¤æ‚åº¦

- **æœ€å¥½æƒ…å†µ**ï¼šO(1) - åŸä½ç½®æœ‰å€¼
- **æœ€åæƒ…å†µ**ï¼šO(7) - æœç´¢æ‰€æœ‰åç§»é‡
- **å¹³å‡æƒ…å†µ**ï¼šO(2) - é€šå¸¸åœ¨åç§»Â±1æ‰¾åˆ°

### 6.2 å®é™…æ€§èƒ½

- å•ä¸ªå…¬å¸å¤„ç†æ—¶é—´: < 5ç§’ï¼ˆæ— æ˜æ˜¾å˜åŒ–ï¼‰
- å†…å­˜ä½¿ç”¨: æ— æ˜æ˜¾å¢åŠ 
- å‡†ç¡®ç‡æå‡: 70% â†’ 100%

---

## ä¸ƒã€åç»­ä¼˜åŒ–å»ºè®®

### 7.1 çŸ­æœŸä¼˜åŒ–

1. **è‡ªé€‚åº”åç§»é‡**ï¼šæ ¹æ®è¡¨æ ¼ç‰¹å¾åŠ¨æ€è°ƒæ•´æœç´¢èŒƒå›´
2. **åç§»é‡ç¼“å­˜**ï¼šè®°å½•æˆåŠŸçš„åç§»é‡ï¼Œä¼˜å…ˆå°è¯•
3. **ç»Ÿè®¡åˆ†æ**ï¼šæ”¶é›†åç§»é‡åˆ†å¸ƒï¼Œä¼˜åŒ–æœç´¢é¡ºåº

### 7.2 é•¿æœŸä¼˜åŒ–

1. **æœºå™¨å­¦ä¹ **ï¼šè®­ç»ƒæ¨¡å‹é¢„æµ‹åˆ—åç§»
2. **PDFç»“æ„åˆ†æ**ï¼šç›´æ¥è§£æåˆå¹¶å•å…ƒæ ¼ä¿¡æ¯
3. **å¯è§†åŒ–è°ƒè¯•**ï¼šæä¾›åˆ—ç»“æ„è¯†åˆ«çš„å¯è§†åŒ–ç•Œé¢

---

## å…«ã€ä¿®æ”¹çš„æ–‡ä»¶

### 8.1 æ ¸å¿ƒä»£ç 

1. **src/parsers/column_analyzer.py**
   - æ–°å¢ `_extract_with_offset` æ–¹æ³•
   - ä¿®æ”¹ `extract_values_from_row` æ–¹æ³•

2. **src/parsers/balance_sheet.py**
   - ä¿®æ”¹ `_extract_values_from_row` æ–¹æ³•
   - ä½¿ç”¨ ColumnAnalyzer çš„æ™ºèƒ½æå–

### 8.2 æµ‹è¯•ä»£ç 

1. **tests/test_haier_debug.py** (æ–°å¢)
   - æµ·å°”æ™ºå®¶ä¸“ç”¨è°ƒè¯•è„šæœ¬

---

## ä¹ã€æ€»ç»“

### 9.1 é—®é¢˜è§£å†³

âœ… **P1é—®é¢˜å®Œå…¨è§£å†³**
- æµ·å°”æ™ºå®¶æ•°æ®æå–å‡†ç¡®ç‡: 70% â†’ 100%
- å¹³å‡å‡†ç¡®ç‡: 92.5% â†’ 100%
- æ‰€æœ‰æµ‹è¯•é€šè¿‡: 4/4

### 9.2 æŠ€æœ¯æˆæœ

âœ… **æ™ºèƒ½åˆ—åç§»æ£€æµ‹æœºåˆ¶**
- è‡ªåŠ¨å¤„ç†åˆå¹¶å•å…ƒæ ¼é—®é¢˜
- æ”¯æŒå¤šç§è¡¨æ ¼æ ¼å¼
- å‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½

### 9.3 ä¸‹ä¸€æ­¥

- âœ… P0é—®é¢˜å·²è§£å†³ï¼ˆæµ·å¤©å‘³ä¸šï¼‰
- âœ… P1é—®é¢˜å·²è§£å†³ï¼ˆæµ·å°”æ™ºå®¶ï¼‰
- ğŸ¯ ä¸‹ä¸€æ­¥ï¼šP2ä¼˜åŒ–ä»»åŠ¡æˆ–æ‰©å±•åˆ°å…¶ä»–æŠ¥è¡¨ç±»å‹

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-02-05
**ä¿®å¤å·¥ç¨‹å¸ˆ**: Claude Code
**ç‰ˆæœ¬**: v1.0.3 (å¾…å‘å¸ƒ)
