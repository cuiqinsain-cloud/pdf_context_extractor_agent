# 利润表解析器问题修复总结

## 问题描述

用户反馈导出的Excel文件存在两个问题：
1. 只有福耀玻璃有数据，其他公司都是"-"
2. 福耀玻璃的数据也不全，比如净利润、营业利润等关键项目缺失

## 问题分析

### 问题1：关键项目缺失

**原因**：正则表达式过于严格，无法匹配包含额外文字的项目名称。

例如：
- PDF中的实际名称：`三、营业利润（亏损以"－"号填列）`
- 原正则表达式：`r'^三、营业利润$'`（要求完全匹配）
- 结果：无法匹配

**解决方案**：放宽正则表达式，使用前缀匹配而非完全匹配。

修改前：
```python
'operating_profit': [r'^三、营业利润$', r'^营业利润$']
'net_profit': [r'^五、净利润$', r'^净利润$']
'parent_net_profit': [r'^归属于母公司所有者的净利润$']
```

修改后：
```python
'operating_profit': [r'^三、营业利润', r'^二、营业利润', r'^营业利润']
'net_profit': [r'^五、净利润', r'^四、净利润', r'^净利润(?!（)']
'parent_net_profit': [r'归属于母公司.*的净利润', r'归属于母公司股东的净利润']
```

### 问题2：其他公司数据为空

**原因**：表头识别失败，导致无法提取数据。

海尔智家的表格结构：
```
['', '项目', '', '', '附注', '', '2024年度', '', '2023年度', '']
```

- 第0列为空
- 项目名称在第1列
- 数据在第6列和第8列

原代码要求识别出"至少2个列类型"就认为找到表头，但这不够严格。

**解决方案**：要求必须同时识别出"本期"和"上期"两列才认为找到表头。

修改前：
```python
if len(column_map) >= 2:
    # 认为找到表头
```

修改后：
```python
has_current = ColumnType.CURRENT_PERIOD in column_map
has_previous = ColumnType.PREVIOUS_PERIOD in column_map

if has_current and has_previous:
    # 认为找到表头
```

### 问题3：Excel导出映射不完整

**原因**：export工具中的item_mapping缺少"持续经营净利润"和"终止经营净利润"。

**解决方案**：添加完整的项目映射。

```python
'profit.continuing_operations_profit': '  持续经营净利润',
'profit.discontinued_operations_profit': '  终止经营净利润',
```

## 修复结果

### 数据完整性

所有4个公司的关键数据都已完整提取：

| 公司 | 营业收入 | 营业利润 | 净利润 | 归属母公司净利润 | 每股收益 |
|------|---------|---------|--------|----------------|---------|
| 福耀玻璃 | ✓ | ✓ | ✓ | ✓ | ✓ |
| 海尔智家 | ✓ | ✓ | ✓ | ✓ | ✓ |
| 海天味业 | ✓ | ✓ | ✓ | ✓ | ✓ |
| 金山办公 | ✓ | ✓ | ✓ | ✓ | ✓ |

### 数据准确性验证

验证公式：净利润 = 归属于母公司净利润 + 少数股东损益

| 公司 | 净利润 | 归属母公司 | 少数股东 | 计算值 | 差额 | 结果 |
|------|--------|-----------|---------|--------|------|------|
| 福耀玻璃 | 7,504,038,370 | 7,497,976,123 | 6,062,247 | 7,504,038,370 | 0.00 | ✓ |
| 海尔智家 | 19,575,612,502 | 18,741,120,123 | 834,492,379 | 19,575,612,502 | 0.00 | ✓ |
| 海天味业 | 6,355,860,951 | 6,344,125,969 | 11,734,982 | 6,355,860,951 | 0.00 | ✓ |
| 金山办公 | 1,655,284,065 | 1,645,080,509 | 10,203,556 | 1,655,284,065 | 0.00 | ✓ |

### 测试结果

```
测试总结
================================================================================
福耀玻璃: ✓ 通过
海尔智家: ✓ 通过
海天味业: ✓ 通过
金山办公: ✓ 通过

总计: 4/4 通过
================================================================================
```

### 验证结果

| 公司 | 总体验证 | 完整性评分 | 层级1验证 | 层级2验证 | 层级3验证 |
|------|---------|-----------|----------|----------|----------|
| 福耀玻璃 | 通过 | 100.0% | 1/1 | 1/1 | 1/1 |
| 海尔智家 | 通过 | 100.0% | 1/1 | 1/1 | 1/1 |
| 海天味业 | 通过 | 100.0% | 1/1 | 1/1 | 1/1 |
| 金山办公 | 通过 | 100.0% | 1/1 | 1/1 | 1/1 |

## 修改的文件

1. **src/parsers/income_statement.py**
   - 放宽正则表达式匹配规则
   - 改进表头识别逻辑

2. **tools/export_income_statement.py**
   - 添加完整的项目映射

3. **src/parsers/column_analyzer.py**
   - 添加利润表特有的列名关键字（"本年度"、"上年度"等）

## 最终输出

**Excel文件**：`output/income_statement_export_20260205_153111.xlsx`

包含两个sheet：
1. **利润表数据**：29行 × 9列，包含所有公司的完整利润表数据
2. **验证结果**：4行，显示每个公司的验证状态

## 经验总结

1. **正则表达式设计**：财务报表中的项目名称经常包含额外的说明文字（如"以'-'号填列"），应使用前缀匹配而非完全匹配。

2. **表头识别**：不同公司的表格格式差异很大，需要更严格的验证条件（必须同时识别出本期和上期）。

3. **数据验证**：通过三层级验证机制，确保提取的数据准确无误。

4. **测试驱动**：通过真实PDF测试，及时发现和修复问题。

## 版本信息

- **修复前版本**：v1.1.0
- **修复后版本**：v1.1.1
- **修复日期**：2026-02-05
- **测试通过率**：100% (4/4)
- **数据完整性**：100%
- **数据准确性**：100%（验证差额为0）
