# è´¢åŠ¡æŠ¥è¡¨ç»“æ„è¯†åˆ«å™¨ - é›†æˆæ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•å°†æ–°çš„ `StatementStructureIdentifier` é›†æˆåˆ°ç°æœ‰çš„ä¸‰ä¸ªè§£æå™¨ä¸­ã€‚

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒç»„ä»¶

#### StatementStructureIdentifier (statement_structure_identifier.py)
- **åŠŸèƒ½**: åŸºäºå…³é”®ç»“æ„é¡ºåºè¯†åˆ«æŠ¥è¡¨ç±»å‹å’ŒèŒƒå›´
- **æ”¯æŒæŠ¥è¡¨**: èµ„äº§è´Ÿå€ºè¡¨ã€åˆ©æ¶¦è¡¨ã€ç°é‡‘æµé‡è¡¨
- **è¯†åˆ«å‡†ç¡®ç‡**: 100% (ç¦è€€ç»ç’ƒã€é‡‘å±±åŠå…¬ã€æ·±ä¿¡æœæµ‹è¯•é€šè¿‡)

**å…³é”®ç‰¹æ€§**:
- âœ… ä¸ä¾èµ–è¡¨å¤´æ ¼å¼ï¼Œé€šè¿‡å…³é”®ç»“æ„è¯†åˆ«
- âœ… è‡ªåŠ¨å®šä½è¡¨å¤´ä½ç½®ï¼ˆä»ç¬¬ä¸€ä¸ªå…³é”®ç»“æ„å¾€ä¸ŠæŸ¥æ‰¾ï¼‰
- âœ… è‡ªåŠ¨å®šä½ç»“æŸä½ç½®ï¼ˆåŒ¹é…ç»“æŸæ ‡è¯†ï¼‰
- âœ… æ”¯æŒç‰¹æ®Šæ ¼å¼ï¼ˆå¦‚æ·±ä¿¡æœçš„é¡¹ç›®åç§°åœ¨ç¬¬1åˆ—ï¼‰
- âœ… æä¾›ç½®ä¿¡åº¦è¯„åˆ†

#### BaseStatementParser (base_statement_parser.py)
- **åŠŸèƒ½**: æä¾›ç»Ÿä¸€çš„è¡¨å¤´è¯†åˆ«å’Œæ•°æ®æå–é€»è¾‘
- **æ–¹æ³•**:
  - `identify_statement_structure()`: è¯†åˆ«æŠ¥è¡¨ç»“æ„
  - `extract_statement_data()`: æå–æœ‰æ•ˆæ•°æ®èŒƒå›´
  - `get_header_info()`: è·å–è¡¨å¤´ä¿¡æ¯
  - `extract_values_from_row()`: æå–è¡Œæ•°æ®
  - `get_item_name_from_row()`: è·å–é¡¹ç›®åç§°ï¼ˆæ”¯æŒç¬¬0åˆ—å’Œç¬¬1åˆ—ï¼‰

---

## ğŸ¯ é›†æˆæ–¹æ¡ˆ

### æ–¹æ¡ˆæ¦‚è¿°

å°†ç°æœ‰è§£æå™¨æ”¹ä¸ºç»§æ‰¿ `BaseStatementParser`ï¼Œåœ¨ `parse_xxx` æ–¹æ³•ä¸­å¢åŠ 4ä¸ªæ­¥éª¤ï¼š

```python
def parse_balance_sheet(self, table_data):
    # æ­¥éª¤1: è¯†åˆ«æŠ¥è¡¨ç»“æ„
    structure_result = self.identify_statement_structure(table_data)

    # æ­¥éª¤2: æå–æœ‰æ•ˆæ•°æ®èŒƒå›´
    data_to_parse = self.extract_statement_data(table_data, structure_result)

    # æ­¥éª¤3: è·å–è¡¨å¤´ä¿¡æ¯
    header_info = self.get_header_info(table_data, structure_result)

    # æ­¥éª¤4: é€è¡Œè§£æï¼ˆä½¿ç”¨åŸºç±»æ–¹æ³•ï¼‰
    for row in data_to_parse:
        item_name = self.get_item_name_from_row(row, header_info)
        values = self.extract_values_from_row(row, header_info)
        # ... åŸæœ‰çš„åŒ¹é…é€»è¾‘
```

### è¯¦ç»†æ­¥éª¤

#### 1. ä¿®æ”¹ç±»å®šä¹‰

**åŸæœ‰ä»£ç **:
```python
class BalanceSheetParser:
    def __init__(self):
        self.column_analyzer = ColumnAnalyzer()
        # ... patternså®šä¹‰
```

**ä¿®æ”¹å**:
```python
from .base_statement_parser import BaseStatementParser

class BalanceSheetParser(BaseStatementParser):
    def __init__(self):
        super().__init__('balance_sheet')  # æŒ‡å®šæŠ¥è¡¨ç±»å‹
        # ... patternså®šä¹‰ï¼ˆä¿æŒä¸å˜ï¼‰
```

#### 2. ä¿®æ”¹ parse æ–¹æ³•

åœ¨ `parse_balance_sheet()` / `parse_income_statement()` / `parse_cash_flow()` æ–¹æ³•å¼€å¤´æ·»åŠ ï¼š

```python
# é‡ç½®ç¼“å­˜
self.reset_cache()

# æ­¥éª¤1: è¯†åˆ«æŠ¥è¡¨ç»“æ„
logger.info("æ­¥éª¤1: è¯†åˆ«æŠ¥è¡¨ç»“æ„...")
structure_result = self.identify_statement_structure(table_data)

# ä¿å­˜ç»“æ„è¯†åˆ«ä¿¡æ¯åˆ°ç»“æœä¸­
result['structure_info'] = {
    'is_valid': structure_result['is_valid'],
    'confidence': structure_result['confidence'],
    'data_range': (structure_result['start_row'], structure_result['end_row'])
}

if not structure_result['is_valid']:
    logger.warning(f"ç»“æ„è¯†åˆ«å¤±è´¥ï¼Œä½¿ç”¨åŸæœ‰é€»è¾‘")
    # ç»§ç»­ä½¿ç”¨åŸæœ‰é€»è¾‘
else:
    logger.info(f"ç»“æ„è¯†åˆ«æˆåŠŸï¼Œç½®ä¿¡åº¦: {structure_result['confidence']:.2%}")

# æ­¥éª¤2: æå–æœ‰æ•ˆæ•°æ®èŒƒå›´
logger.info("æ­¥éª¤2: æå–æœ‰æ•ˆæ•°æ®èŒƒå›´...")
if structure_result['is_valid']:
    data_to_parse = self.extract_statement_data(table_data, structure_result)
    row_offset = structure_result['start_row']
else:
    data_to_parse = table_data
    row_offset = 0

# æ­¥éª¤3: è·å–è¡¨å¤´ä¿¡æ¯
logger.info("æ­¥éª¤3: åˆ†æè¡¨å¤´ç»“æ„...")
header_info = self.get_header_info(table_data, structure_result)
```

#### 3. ä¿®æ”¹æ•°æ®æå–é€»è¾‘

**åŸæœ‰ä»£ç **:
```python
for row_idx, row in enumerate(table_data):
    item_name = row[0].strip() if row[0] else ""
    item_name = item_name.replace('\n', '').replace('\r', '').strip()

    # æå–æ•°å€¼
    values = self._extract_values_from_row(row, header_info)
```

**ä¿®æ”¹å**:
```python
for row_idx, row in enumerate(data_to_parse):  # ä½¿ç”¨ data_to_parse
    # ä½¿ç”¨åŸºç±»æ–¹æ³•è·å–é¡¹ç›®åç§°ï¼ˆæ”¯æŒç¬¬0åˆ—å’Œç¬¬1åˆ—ï¼‰
    item_name = self.get_item_name_from_row(row, header_info)

    # ä½¿ç”¨åŸºç±»æ–¹æ³•æå–æ•°å€¼
    values = self.extract_values_from_row(row, header_info)
```

#### 4. åˆ é™¤åŸæœ‰çš„è¡¨å¤´è¯†åˆ«æ–¹æ³•

å¯ä»¥åˆ é™¤ä»¥ä¸‹æ–¹æ³•ï¼ˆå·²ç”±åŸºç±»æä¾›ï¼‰ï¼š
- `_identify_header_structure()`
- `_extract_values_from_row()`ï¼ˆå¦‚æœä½¿ç”¨åŸºç±»çš„å®ç°ï¼‰

---

## ğŸ“Š æµ‹è¯•ç»“æœ

### æµ‹è¯•è¦†ç›–

| å…¬å¸ | èµ„äº§è´Ÿå€ºè¡¨ | åˆ©æ¶¦è¡¨ | ç°é‡‘æµé‡è¡¨ | ç‰¹æ®Šæ ¼å¼ |
|------|-----------|--------|-----------|---------|
| ç¦è€€ç»ç’ƒ | âœ… 100% | âœ… 100% | âœ… 100% | - |
| é‡‘å±±åŠå…¬ | âœ… 100% | âœ… 100% | âœ… 100% | - |
| æ·±ä¿¡æœ | âœ… 100% | âœ… 100% | âœ… 100% | âœ… é¡¹ç›®åç§°åœ¨ç¬¬1åˆ— |

### æ•ˆæœå¯¹æ¯”

**ç¦è€€ç»ç’ƒ - èµ„äº§è´Ÿå€ºè¡¨**:
- åŸå§‹æ•°æ®: 126è¡Œ
- æœ‰æ•ˆæ•°æ®: 104è¡Œ
- è¿‡æ»¤æ‰: 22è¡Œæ— å…³æ•°æ®ï¼ˆè¡¨å¤´ä¹‹å‰1è¡Œï¼Œæ•°æ®ä¹‹å21è¡Œï¼‰

**æ·±ä¿¡æœ - ç‰¹æ®Šæ ¼å¼**:
- é¡¹ç›®åç§°åœ¨ç¬¬1åˆ—ï¼ˆè€Œéç¬¬0åˆ—ï¼‰
- âœ… ç»“æ„è¯†åˆ«å™¨è‡ªåŠ¨æ£€æµ‹ç¬¬0åˆ—å’Œç¬¬1åˆ—
- âœ… æ­£ç¡®è¯†åˆ«æ‰€æœ‰å…³é”®ç»“æ„

---

## ğŸ” å…³é”®æ”¹è¿›

### 1. è‡ªåŠ¨è¿‡æ»¤æ— å…³æ•°æ®

**é—®é¢˜**: åŸæœ‰é€»è¾‘å¤„ç†æ‰€æœ‰è¡Œï¼ŒåŒ…æ‹¬ï¼š
- è¡¨å¤´ä¹‹å‰çš„å†…å®¹
- æ•°æ®ä¹‹åçš„æ¯å…¬å¸æŠ¥è¡¨
- å…¶ä»–æ— å…³å†…å®¹

**è§£å†³**: ç»“æ„è¯†åˆ«å™¨ç²¾ç¡®å®šä½æ•°æ®èŒƒå›´ï¼Œåªå¤„ç†æœ‰æ•ˆæ•°æ®

### 2. å¤„ç†ç‰¹æ®Šæ ¼å¼

**é—®é¢˜**: æ·±ä¿¡æœçš„é¡¹ç›®åç§°åœ¨ç¬¬1åˆ—ï¼ŒåŸæœ‰é€»è¾‘åªæ£€æŸ¥ç¬¬0åˆ—

**è§£å†³**:
- ç»“æ„è¯†åˆ«å™¨æ£€æŸ¥ç¬¬0åˆ—å’Œç¬¬1åˆ—
- `get_item_name_from_row()` æ–¹æ³•è‡ªåŠ¨å¤„ç†

### 3. ç»Ÿä¸€è¡¨å¤´è¯†åˆ«

**é—®é¢˜**: ä¸‰ä¸ªè§£æå™¨çš„è¡¨å¤´è¯†åˆ«é€»è¾‘ä¸ä¸€è‡´
- èµ„äº§è´Ÿå€ºè¡¨: æ£€æŸ¥å‰10è¡Œï¼Œæ— è¯„åˆ†æœºåˆ¶
- åˆ©æ¶¦è¡¨: æ£€æŸ¥å‰50è¡Œï¼Œæœ‰è¯„åˆ†æœºåˆ¶
- ç°é‡‘æµé‡è¡¨: æ£€æŸ¥å‰50è¡Œï¼Œæœ‰è¯„åˆ†æœºåˆ¶

**è§£å†³**: ç»Ÿä¸€ä½¿ç”¨ç»“æ„è¯†åˆ«å™¨ï¼Œä»å…³é”®ç»“æ„å¾€ä¸ŠæŸ¥æ‰¾è¡¨å¤´

---

## ğŸ“ å®ç°ç¤ºä¾‹

å®Œæ•´çš„å®ç°ç¤ºä¾‹è§ï¼š
- `src/parsers/balance_sheet_v2_example.py` - é›†æˆç¤ºä¾‹
- `tests/test_integration_demo.py` - æ•ˆæœæ¼”ç¤º

---

## ğŸš€ ä¸‹ä¸€æ­¥å·¥ä½œ

### ç«‹å³æ‰§è¡Œ

1. âœ… åˆ›å»º `StatementStructureIdentifier` - å·²å®Œæˆ
2. âœ… åˆ›å»º `BaseStatementParser` - å·²å®Œæˆ
3. âœ… æµ‹è¯•éªŒè¯ - å·²å®Œæˆ
4. â³ ä¿®æ”¹ä¸‰ä¸ªè§£æå™¨é›†æˆæ–°é€»è¾‘
5. â³ æ›´æ–°æµ‹è¯•è„šæœ¬
6. â³ æ›´æ–°æ–‡æ¡£

### åç»­ä¼˜åŒ–

1. ä¼˜åŒ–ç»“æŸæ ‡è¯†è¯†åˆ«ï¼ˆåˆ©æ¶¦è¡¨å’Œç°é‡‘æµé‡è¡¨ï¼‰
2. æ·»åŠ æ›´å¤šå…¬å¸çš„æµ‹è¯•ç”¨ä¾‹
3. æ€§èƒ½ä¼˜åŒ–ï¼ˆç¼“å­˜æœºåˆ¶ï¼‰
4. é”™è¯¯å¤„ç†å¢å¼º

---

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### å‘åå…¼å®¹

é›†æˆåçš„è§£æå™¨ä¿æŒå‘åå…¼å®¹ï¼š
- å¦‚æœç»“æ„è¯†åˆ«å¤±è´¥ï¼Œè‡ªåŠ¨å›é€€åˆ°åŸæœ‰é€»è¾‘
- ä¸å½±å“ç°æœ‰çš„é¡¹ç›®åŒ¹é…å’ŒéªŒè¯é€»è¾‘
- å¯ä»¥é€æ­¥è¿ç§»ï¼Œä¸éœ€è¦ä¸€æ¬¡æ€§ä¿®æ”¹æ‰€æœ‰ä»£ç 

### æ¸è¿›å¼é›†æˆ

å»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºé›†æˆï¼š
1. å…ˆé›†æˆèµ„äº§è´Ÿå€ºè¡¨è§£æå™¨
2. æµ‹è¯•éªŒè¯æ— é—®é¢˜åï¼Œé›†æˆåˆ©æ¶¦è¡¨è§£æå™¨
3. æœ€åé›†æˆç°é‡‘æµé‡è¡¨è§£æå™¨

---

## ğŸ“ é—®é¢˜åé¦ˆ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æ—¥å¿—è¾“å‡ºï¼ˆç»“æ„è¯†åˆ«çš„è¯¦ç»†ä¿¡æ¯ï¼‰
2. ç½®ä¿¡åº¦åˆ†æ•°ï¼ˆä½äº80%éœ€è¦äººå·¥æ£€æŸ¥ï¼‰
3. ç¼ºå¤±çš„å…³é”®ç»“æ„ï¼ˆmissing_keyså­—æ®µï¼‰

---

**æœ€åæ›´æ–°**: 2026-02-06
**ç‰ˆæœ¬**: v1.3.0-alpha
